# 使用微调模型进行预测

## 前提条件

确保已完成微调训练，生成了模型文件：
```
finetuning_output/finetuned_model.pt
```

## 使用方法

### **方法 1: 快速预测单个列（推荐）**

预测 OT 列：
```bash
python3 quick_predict.py --column OT --plot
```

预测其他列：
```bash
python3 quick_predict.py --column 0 --plot
python3 quick_predict.py --column 15 --plot
```

**输出：**
- `predictions/forecast_OT.csv` - 预测结果（含分位数）
- `predictions/forecast_OT.png` - 预测可视化图表

---

### **方法 2: 批量预测所有列**

预测所有 36 个列：
```bash
python3 predict_with_finetuned_model.py
```

**输出：**
- `predictions/forecasts_with_dates.csv` - 所有列的预测（含日期）
- `predictions/forecast_<列名>.csv` - 每列的详细预测
- `predictions/all_forecasts_summary.csv` - 汇总文件

---

## 命令行参数

### quick_predict.py

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--column` | 要预测的列名 | `OT` |
| `--model` | 模型路径 | `finetuning_output/finetuned_model.pt` |
| `--data` | 数据文件 | `east_settlement.csv` |
| `--output` | 输出目录 | `predictions` |
| `--plot` | 是否绘图 | False |

**示例：**
```bash
# 预测列 "3" 并保存图表
python3 quick_predict.py --column 3 --plot

# 使用自定义模型
python3 quick_predict.py --column OT --model my_model.pt --plot

# 指定输出目录
python3 quick_predict.py --column OT --output my_predictions --plot
```

---

## 输出文件格式

### 预测结果 CSV (forecast_OT.csv)

| 列名 | 说明 |
|------|------|
| `step` | 预测步数 (1-128) |
| `point_forecast` | 点预测（中位数） |
| `q10` | 10% 分位数 |
| `q20` | 20% 分位数 |
| ... | ... |
| `q90` | 90% 分位数 |

### 带日期的预测 (forecasts_with_dates.csv)

| 列名 | 说明 |
|------|------|
| `date` | 预测时间（小时频率） |
| `0` | 列 0 的预测值 |
| `1` | 列 1 的预测值 |
| ... | ... |
| `OT` | OT 列的预测值 |

---

## 预测配置

### 输入配置
- **上下文长度**: 512 个时间步（最后 512 个历史值）
- **频率类型**: 0（高频 - 小时数据）

### 输出配置
- **预测长度**: 128 个时间步（未来 128 小时 ≈ 5.3 天）
- **分位数**: [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9]

---

## 自定义预测

### 在 Python 中使用

```python
import torch
import numpy as np
from pathlib import Path
from quick_predict import load_model, predict_column

# 加载模型
model_path = "finetuning_output/finetuned_model.pt"
model, config = load_model(model_path)

# 准备数据（最少需要 512 个历史点）
data = np.array([...])  # 你的时间序列数据

# 预测
point_forecast, quantile_forecasts = predict_column(model, data)

print(f"预测值: {point_forecast}")
print(f"10% 分位数: {quantile_forecasts[:, 0]}")
print(f"90% 分位数: {quantile_forecasts[:, 8]}")
```

### 修改预测长度

如果想预测不同长度（需要重新训练模型）：

```python
# 在 finetune_timesfm2_east.py 中修改
tfm_config = TimesFMConfig(
    ...
    horizon_len=256,  # 改为 256
    ...
)
```

---

## 可视化说明

### 预测图表包含：

1. **蓝色线** - 历史数据（最后 512 个点）
2. **红色线** - 点预测（未来 128 个点）
3. **红色阴影** - 80% 置信区间（10%-90% 分位数）
4. **灰色虚线** - 预测起点

### 解读置信区间：

- **窄区间** - 模型对预测有信心
- **宽区间** - 预测不确定性较大
- **区间扩大** - 随着时间越远，不确定性增加（正常）

---

## 注意事项

### 1. 数据长度要求
```python
# 最少需要 512 个历史点
if len(data) < 512:
    print("错误：数据长度不足")
```

### 2. 数据尺度
- 模型会自动归一化输入
- 预测输出已恢复到原始尺度
- 无需手动标准化

### 3. 设备要求
- **GPU**: 推荐，预测速度快
- **CPU**: 可用，但速度较慢（~10倍）

### 4. 内存要求
- 单列预测: ~2GB
- 批量预测（36列）: ~4GB

---


### 判断预测质量

**方法 1**: 看置信区间宽度
```python
q10 = quantile_forecasts[:, 0]
q90 = quantile_forecasts[:, 8]
interval_width = (q90 - q10).mean()

print(f"平均置信区间宽度: {interval_width}")
# 越小越好，说明预测越确定
```

**方法 2**: 与历史数据比较
```python
historical_mean = data.mean()
forecast_mean = point_forecast.mean()

print(f"历史均值: {historical_mean}")
print(f"预测均值: {forecast_mean}")
# 应该在合理范围内
```

### 如果预测值不合理

1. **检查训练质量**
   - 查看训练 loss 是否收敛
   - 检查验证 loss 是否合理

2. **检查数据质量**
   - 确认输入数据无异常值
   - 确认数据趋势正常

3. **调整预测**
   - 使用不同的分位数（如 q50 而不是 point_forecast）
   - 使用更多历史数据（增加 context_length）

### 预测更长时间？

**方法 1**: 滚动预测
```python
# 预测下一个 128 步
forecast_1 = predict_column(model, data)

# 将预测加入历史，预测再下一个 128 步
extended_data = np.concatenate([data, forecast_1])
forecast_2 = predict_column(model, extended_data)
```

**方法 2**: 重新训练更大 horizon_len 的模型

---

## 完整示例

### 示例 1: 预测并分析 OT 列

```bash
# 1. 预测
python3 quick_predict.py --column OT --plot

# 2. 查看结果
cat predictions/forecast_OT.csv | head -10

# 3. 计算统计
python3 -c "
import pandas as pd
df = pd.read_csv('predictions/forecast_OT.csv')
print(f'预测均值: {df.point_forecast.mean():.2f}')
print(f'预测最大: {df.point_forecast.max():.2f}')
print(f'预测最小: {df.point_forecast.min():.2f}')
"
```

### 示例 2: 批量预测并导出

```bash
# 1. 预测所有列
python3 predict_with_finetuned_model.py

# 2. 查看汇总
head predictions/forecasts_with_dates.csv

# 3. 统计所有列的预测范围
python3 -c "
import pandas as pd
df = pd.read_csv('predictions/forecasts_with_dates.csv')
print(df.describe())
"
```
